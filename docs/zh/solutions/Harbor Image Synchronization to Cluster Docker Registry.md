---
id: KB250600014
products:
  - Alauda Container Platform
  - Alauda DevOps
kind:
  - Solution
sourceSHA: f6e1c5df0746b9a0864d13ffea4554439c918314012bd121646dbc32ba5441ed
---

# Harbor 镜像同步到集群 Docker 注册表

本指南解释了如何配置 Harbor 复制规则，以便在新镜像推送时自动将镜像从 Harbor 同步到集群中的 Docker 注册表。

## 前提条件

- 一个正在运行的 Harbor 服务
- 本地安装的 Docker 客户端或其他镜像管理工具，用于将镜像推送到 Harbor
- 部署了 Docker 注册表的 Kubernetes 集群
- 本地安装并配置了 kubectl，以访问 Kubernetes 集群

## 概述

**Harbor 中的关键配置**

- **注册表端点**：将目标 Docker 注册表信息添加到 Harbor
- **复制规则**：定义要同步的镜像及其同步路径

**流程概述**

| 步骤 | 操作                        | 描述                                          |
| ---- | --------------------------- | --------------------------------------------- |
| 1    | 配置注册表端点             | 将目标集群注册表端点添加到 Harbor            |
| 2    | 配置复制规则               | 定义镜像同步策略                            |
| 3    | 验证镜像同步               | 测试同步工作流                                |

## 配置步骤

### 步骤 1：在 Harbor 中配置注册表端点

首先，使用 `注册表端点` 功能在 Harbor 中配置目标 Docker 注册表信息。

1. 登录到 Harbor，导航到 **管理 > 注册表**
2. 点击 **新建端点** 并配置以下内容：

- **提供者**：选择您的注册表类型。在本示例中，选择 `Docker Registry`
- **名称**：为您的目标注册表提供一个描述性名称。我们建议使用格式 `<集群名称>-registry` 以便于识别。
- **端点 URL**：输入您的注册表 URL（例如，`https://cluster1-registry.example.com`）
- **访问 ID**：具有 `推送/删除` 权限的用户名
- **访问密钥**：上述用户的密码
- **验证远程证书**：确定是否验证远程注册表的证书。对于自签名或不受信任的证书，请取消勾选

3. 点击 **测试连接** 以验证配置和网络连接
4. 点击 **确定** 保存配置

### 步骤 2：在 Harbor 中配置复制规则

接下来，配置复制规则以定义 Harbor 如何将镜像同步到目标注册表。

1. 导航到 **管理 > 复制**
2. 点击 **新建复制规则** 并配置：

**基本设置**

- **名称**：使用描述性名称，例如 `<集群名称>-registry-replication`
- **复制模式**：选择 `基于推送`，以便在镜像推送到 Harbor 时触发同步

**源资源过滤器**

配置过滤器以识别要复制的工件：

- **名称**：按资源名称过滤。留空或使用 `**` 匹配所有。在本示例中，留空以同步所有仓库
- **标签**：按标签/版本过滤。留空或使用 `**` 匹配所有标签。在本示例中，留空以同步所有标签
- **标签**：按工件标签过滤。留空以匹配所有工件。在本示例中，留空以同步所有工件
- **资源**：过滤资源类型。在本示例中，选择 `所有` 以同步所有工件类型

**目标**

定义同步目标和路径结构：

- **目标注册表**：选择在步骤 1 中配置的注册表端点
- **命名空间**：要复制资源的命名空间名称。如果为空，资源将放在与源相同的命名空间中。在本示例中，留空以使用与源相同的命名空间
- **扁平化**：在复制镜像时减少嵌套的仓库结构。留空以保留原始镜像层次结构

**附加设置**

- **触发模式**：决定如何触发同步。选择 `基于事件` 以在 Harbor 推送事件时触发同步
  - 如果希望 Harbor 中的删除操作传播到目标注册表，请勾选“本地删除时删除远程资源”
- **带宽**：设置每个复制工作者的最大网络带宽（使用 -1 表示无限制）
- **选项**：
  - 勾选 `覆盖` 以覆盖目标位置的现有资源
  - 勾选 `启用规则` 以激活复制规则

### 步骤 3：验证镜像同步

**将镜像推送到 Harbor**

将镜像推送到 Harbor 以触发同步：

```bash
docker pull alpine:latest
docker tag alpine:latest <your-harbor-address>/library/alpine:latest
docker push <your-harbor-address>/library/alpine:latest
```

**在 Harbor 中监控同步作业**

1. 在 Harbor 中，导航到 **管理 > 复制**
2. 选择您新创建的复制规则以查看自动触发的同步作业
3. 点击执行记录以查看详细信息

**验证同步结果**

在目标集群中创建一个 Pod，以测试镜像是否成功同步：

```bash
kubectl run alpine-test --image=<your-cluster-registry-address>/library/alpine:latest -- sleep 3600
```

如果 Pod 成功启动，则同步工作正常。

## 总结

此配置建立了从 Harbor 到集群注册表的自动镜像同步，保持一致的镜像路径，并在您的基础设施中实现无缝的部署工作流。基于推送的复制确保在镜像推送到 Harbor 后，目标注册表中立即可用这些镜像。

## 参考

- [Harbor 复制](https://goharbor.io/docs/2.12.0/administration/configuring-replication/)
